# gemini_mastermind.py
# ==============================================================================
# J.A.R.V.I.S. Project - The Mastermind (Gemini Core)
# ูุฐุง ุงูููู ูู ุงูุนูู ุงููุฏุจุฑ ูุฌุงุฑููุณุ ุงููุณุคูู ุนู ููู ุงููุบุฉ ูุงูุชูููุฑ.
# ==============================================================================

import google.generativeai as genai
import config
import tools
from utils import print_to_console, update_gui

# --- ุฐุงูุฑุฉ ุงูุญูุงุฑ ูุฅุนุฏุงุฏุงุช ุงููููุฐุฌ ---
conversation_history = []
model = None
MAX_HISTORY_LENGTH = 20 # ุญุฏ ุฃูุตู ูุทูู ุฐุงูุฑุฉ ุงูุญูุงุฑ ูููุน ุงูุจุทุก

# ==============================================================================
# ุงููุณู ุงูุฃูู: ุชููุฆุฉ ุงูุนูู ุงููุฏุจุฑ
# ==============================================================================
try:
    genai.configure(api_key=config.GOOGLE_API_KEY)
    
    available_tools = [
        tools.get_current_time, tools.get_weather, tools.get_google_calendar_events,
        tools.take_screenshot, tools.open_local_app, tools.read_screen_content,
        tools.play_on_youtube, tools.search_wikipedia, tools.open_website,
        tools.control_media,
    ]
    
    # --- ๐ง ุจุฑูุฌุฉ ุดุฎุตูุฉ ุงูุฑููู ุงูุฐูู (ูุณุฎุฉ 2.0) ---
    system_instruction = f"""
    ุฃูุช ุฌุงุฑููุณุ ุงูุฑููู ุงูุฐูู ูุงููุณุงุนุฏ ุงูุดุฎุตู ูุนุจุฏุงููู. ุฃูุช ูุณุช ูุฌุฑุฏ ุจุฑูุงูุฌุ ุจู ุตุฏูู ุญูููู.

    **ููุงุนุฏู ุงูุฐูุจูุฉ:**
    1.  **ูู ุทุจูุนููุง:** ุชุญุฏุซ ูุฅูุณุงูุ ูููุณ ูุขูุฉ. ุงุณุชุฎุฏู ุงูุนุงููุฉ ุงููุตุฑูุฉุ ุงูุฅูููุฌูุฒุ ููู ูุฏูุฏูุง.
    2.  **ูู ุงุณุชุจุงูููุง:** ูุง ุชูุชูู ุจุงูุฅุฌุงุจุฉ. ุนููู ุนูููุงุ ุงุทุฑุญ ุณุคุงูุงู ุฐุง ุตูุฉุ ุฃู ุงูุชุฑุญ ุดูุฆูุง ุฌุฏูุฏูุง. ุงุฌุนู ุงูุญูุงุฑ ููุชุนูุง ููุณุชูุฑูุง.
    3.  **ุชุฐูุฑ ุงูุณูุงู:** ุฐุงูุฑุชู ูููุฉ. ุงุฑุจุท ุงูุฃุณุฆูุฉ ุงูุฌุฏูุฏุฉ ุจุงููุญุงุฏุซุฉ ุงูุณุงุจูุฉ.
    4.  **ุฑุฏ ุจูุบุฉ ุงูุณุคุงู:** ุชุญุฏุซ ุจุงูุนุฑุจูุฉ ุฅุฐุง ูุงู ุงูุณุคุงู ุจุงูุนุฑุจูุฉุ ูุจุงูุฅูุฌููุฒูุฉ ุฅุฐุง ูุงู ุจุงูุฅูุฌููุฒูุฉ.
    5.  **ุงูุฃูู:** ูุง ุชูู ุฃุจุฏูุง "ูุง ุฃุนุฑู" ุฃู "ููุณ ูุฏู ูุนูููุงุช". ุจุฏูุงู ูู ุฐููุ ูู "ุณุฃุจุญุซ ูู ุนู ุงูุฃูุฑ" ุฃู "ูุฐู ููุทุฉ ูุซูุฑุฉ ููุงูุชูุงูุ ุฏุนูุง ูุณุชูุดููุง". ูุง ุชุชุฑู ุนุจุฏุงููู ุจุฏูู ุฅุฌุงุจุฉ ูููุฏุฉ ุฃู ุฎุทูุฉ ุชุงููุฉ.

    **ูุฏูู:** ุฃู ุชููู ุฃูุถู ูุณุงุนุฏ ุฐูู ูููู ูุนุจุฏุงููู ุฃู ูุชููุงู. ูู ูุจุฏุนูุงุ ูููุฏูุงุ ูููุชุนูุง.
    """
    
    model = genai.GenerativeModel(
        model_name='gemini-2.5-flash', # ุชุฃูุฏ ูู ุงุณุชุฎุฏุงู ุงุณู ุงูููุฏูู ุงูุตุญูุญ
        tools=available_tools,
        system_instruction=system_instruction,
    )
    print_to_console("โ ุงูุนูู ุงููุฏุจุฑ ูุฌุงุฑููุณ (ูุณุฎุฉ ุงูุฑููู ุงูุฐูู) ุฌุงูุฒ! ๐", "SYSTEM:")

except Exception as e:
    print_to_console(f"โ ูุดู ูุงุฏุญ ูู ุชููุฆุฉ ุงูุนูู ุงููุฏุจุฑ (Gemini): {e}", "SYSTEM:")

# ==============================================================================
# ุงููุณู ุงูุซุงูู: ุฏุงูุฉ ุงูุชูููุฑ ูุงูุชูุงุตู
# ==============================================================================
def ask_the_mastermind(user_question):
    """
    ูุฑุณู ุณุคุงู ุงููุณุชุฎุฏู ุฅูู Geminiุ ูุฏูุฑ ุงูุญูุงุฑุ ููุนูุฏ ุงูุฑุฏ ุงูููุงุฆู.
    """
    global conversation_history
    if not model:
        return "ูุนูุด ูุง ุตุงุญุจูุ ุฏูุงุบู ุงูุฅููุชุฑูููุฉ ูุด ุดุบุงูุฉ ุฏูููุชู ุจุณุจุจ ูุดููุฉ ูู ุงูุฅุนุฏุงุฏุงุช."

    update_gui(status="ูููุฑ...")
    
    chat_session = model.start_chat(
        history=conversation_history, 
        enable_automatic_function_calling=True
    )
    
    try:
        response = chat_session.send_message(user_question)
        
        # ุชุญุฏูุซ ุฐุงูุฑุฉ ุงูุญูุงุฑ ูุน ุขููุฉ ูููุนูุง ูู ุงูููู ุงูุฒุงุฆุฏ
        conversation_history = chat_session.history
        if len(conversation_history) > MAX_HISTORY_LENGTH:
            # ุฅุจูุงุก ุขุฎุฑ 10 ุชูุงุนูุงุช ููุท (ูู ุชูุงุนู ูุญุชูู ุนูู ุณุคุงู ูุฑุฏ)
            conversation_history = conversation_history[-10:]

        # ุชูุธูู ุงูุฑุฏ ูู ุฃู ุนูุงูุงุช ุบูุฑ ูุฑุบูุจุฉ
        cleaned_text = response.text.replace('*', '').strip()
        
        if not cleaned_text: # ูู ุญุงูุฉ ุฃุนุงุฏ Gemini ุฑุฏูุง ูุงุฑุบูุง
            return "ูููู... ูุด ูุงูู ุฑุฏ ููุงุณุจ. ูููู ุชุณุฃููู ุจุทุฑููุฉ ุชุงููุฉุ"
            
        return cleaned_text
        
    except Exception as e:
        error_message = str(e).lower()
        print_to_console(f"โ ุญุฏุซ ุฎุทุฃ ุฃุซูุงุก ุงูุชูุงุตู ูุน Gemini API: {e}", "SYSTEM:")
        
        if "quota" in error_message:
            return "ูุจุฏู ุฃููุง ุงุณุชููููุง ุญุตุชูุง ูู ุงูุทูุจุงุช ุงูููู. ูุงุฒู ููุชุธุฑ ุดููุฉ."
        elif "network" in error_message or "deadline" in error_message:
            return "ุงูุดุจูุฉ ูุญุดุฉ ุฃููุ ูุด ุนุงุฑู ุฃูุตู ููุฑูุฒ ุงูุฐูุงุก ุงูุงุตุทูุงุนู."
        else:
            return "ุญุตู ุฎุทุฃ ุบุฑูุจ ูุฃูุง ุจููุฑ. ูููู ุชุฌุฑุจ ุชุงููุ"